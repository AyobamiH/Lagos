const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MapPicker-DSPx7sIn.js","assets/index-CQqwMk0w.js","assets/index-zbX1gslc.css","assets/TileLayer-Bir63tuw.js","assets/leaflet-CEdCld2y.js","assets/leaflet-Dgihpmma.css"])))=>i.map(i=>d[i]);
import{u as O,r as s,R as W,j as e,c as M,f as E,_ as F}from"./index-CQqwMk0w.js";import{a as p,p as f}from"./validation-Bd_H_RqW.js";import{f as J}from"./format-CHNCD0FC.js";const V=s.lazy(()=>F(()=>import("./MapPicker-DSPx7sIn.js"),__vite__mapDeps([0,1,2,3,4,5])).then(g=>({default:g.MapPicker})));function U(){const{token:g}=O(),[i,_]=s.useState({lat:"6.5244",lng:"3.3792"}),[o,q]=s.useState({lat:"37.7849",lng:"-122.4094"}),[h,N]=s.useState("standard"),[n,L]=s.useState(null),[k,v]=s.useState(null),[b,I]=s.useState(Date.now());W.useEffect(()=>{const a=setInterval(()=>I(Date.now()),1e3);return()=>clearInterval(a)},[]);const[x,c]=s.useState(null),[w,P]=s.useState(null),[Q,D]=s.useState(!1),[A,C]=s.useState(!1),[T,R]=s.useState(null),d=s.useRef(!1);async function y(a){if(a&&a.preventDefault(),!g){c("not_authenticated");return}c(null),L(null),v(null),P(null),R(null),D(!0);const t=performance.now(),r=performance.now();try{const l=f(i.lat),u=p(i.lng),j=f(o.lat),m=p(o.lng);if([l,u,j,m].some(G=>G===null))throw{error:"invalid_coordinates"};const S=await M.getQuote({pickup:{lat:l,lng:u},dropoff:{lat:j,lng:m},productType:h});L(S),E("get_quote_success",{productType:h},r)}catch(l){const u=(l==null?void 0:l.code)||(l==null?void 0:l.error);c(u==="rate_limited"?"rate_limited":u||"quote_failed")}P(Math.round(performance.now()-t)),D(!1)}async function z(){if(!g||!n)return;c(null),v(null),C(!0),R(null);const a=performance.now();try{const t=f(i.lat),r=p(i.lng),l=f(o.lat),u=p(o.lng);if([t,r,l,u].some(S=>S===null))throw{error:"invalid_coordinates"};const j={pickup:{lat:t,lng:r},dropoff:{lat:l,lng:u},productType:h,quotePayload:n.payload,quoteSignature:n.signature,quoteId:n.quoteId},m=await M.rideRequest(g,j);v(m),E("request_ride_success",{productType:h},a)}catch(t){const r=(t==null?void 0:t.code)||(t==null?void 0:t.error);if(["expired_quote","invalid_quote_signature","quote_mismatch","quote_replay_detected","invalid_quote_payload","stateless_required_missing_payload"].includes(r)){if(!d.current){d.current=!0;try{R("Refreshing quote due to validation issue"),await y()}catch{}d.current=!1}c(r)}else c(r||"ride_failed")}C(!1)}return e.jsxs("div",{style:{display:"grid",gap:16},children:[e.jsx("h2",{children:"Quote & Request"}),e.jsxs("form",{"aria-label":"Get ride quote",onSubmit:y,style:{display:"grid",gap:8,maxWidth:380},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("label",{style:{flex:1},children:["Pickup Lat",e.jsx("input",{"aria-label":"Pickup latitude",value:i.lat,onChange:a=>_(t=>({...t,lat:a.target.value}))})]}),e.jsxs("label",{style:{flex:1},children:["Pickup Lng",e.jsx("input",{"aria-label":"Pickup longitude",value:i.lng,onChange:a=>_(t=>({...t,lng:a.target.value}))})]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("label",{style:{flex:1},children:["Drop Lat",e.jsx("input",{"aria-label":"Dropoff latitude",value:o.lat,onChange:a=>q(t=>({...t,lat:a.target.value}))})]}),e.jsxs("label",{style:{flex:1},children:["Drop Lng",e.jsx("input",{"aria-label":"Dropoff longitude",value:o.lng,onChange:a=>q(t=>({...t,lng:a.target.value}))})]})]}),e.jsxs("label",{children:["Product Type",e.jsxs("select",{"aria-label":"Product type",value:h,onChange:a=>N(a.target.value),children:[e.jsx("option",{value:"standard",children:"Standard"}),e.jsx("option",{value:"premium",children:"Premium"})]})]}),e.jsx("button",{"aria-label":"Fetch fare quote",disabled:Q,children:Q?"Fetching...":"Get Quote"})]}),w!==null&&e.jsxs("span",{style:{fontSize:12,opacity:.7},children:["quote lat ",w,"ms"]}),e.jsx(s.Suspense,{fallback:e.jsx("div",{style:{height:300,display:"flex",alignItems:"center",justifyContent:"center"},children:"Loading map..."}),children:e.jsx(V,{pickup:{lat:f(i.lat)||0,lng:p(i.lng)||0},dropoff:{lat:f(o.lat)||0,lng:p(o.lng)||0},onChange:a=>{const t=a.pickup,r=a.dropoff;t&&typeof t.lat=="number"&&_(l=>({...l,lat:String(t.lat),lng:String(t.lng)})),r&&typeof r.lat=="number"&&q(l=>({...l,lat:String(r.lat),lng:String(r.lng)}))}})}),n&&e.jsxs("div",{style:{background:"#f0f8ff",padding:8,borderRadius:4},"aria-live":"polite",children:[e.jsx("h3",{style:{marginTop:0},children:"Quote"}),e.jsxs("p",{children:["Total: ",J(n.total)," (surge ",n.surgeMultiplier,")"]}),n.expiresAt&&e.jsxs("p",{"aria-label":"Quote expiry",style:{fontSize:12,marginTop:4},children:["Expires in ",Math.max(0,Math.floor((new Date(n.expiresAt).getTime()-b)/1e3)),"s"]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{"aria-label":"Request ride with this quote",onClick:z,disabled:A||n.expiresAt&&new Date(n.expiresAt).getTime()<b,children:A?"Requesting...":"Request With Quote"}),n.expiresAt&&new Date(n.expiresAt).getTime()<b&&e.jsx("button",{"aria-label":"Refresh expired quote",onClick:()=>y(),children:"Refresh Quote"})]}),e.jsx("pre",{children:JSON.stringify(n,null,2)})]}),k&&e.jsxs("div",{style:{background:"#f5f5f5",padding:8,borderRadius:4},children:[e.jsx("h3",{style:{marginTop:0},children:"Ride Response"}),e.jsx("pre",{children:JSON.stringify(k,null,2)})]}),x&&e.jsx("p",{style:{color:"red"},"aria-live":"assertive",children:x}),T&&e.jsx("p",{style:{color:"#555",fontSize:12},"aria-live":"polite",children:T}),x&&["expired_quote","quote_mismatch","quote_replay_detected"].includes(x)&&!n&&e.jsx("button",{onClick:()=>{d.current||y()},style:{width:180},disabled:d.current,children:d.current?"Refreshing...":"Recalculate Quote"})]})}export{U as default};
