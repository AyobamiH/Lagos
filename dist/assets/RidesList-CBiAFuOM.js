import{c as F,h as L,u as T,i as $,r as i,j as e,L as N}from"./index-CQqwMk0w.js";import{f as O}from"./format-CHNCD0FC.js";async function P(n,s,c,g){const l=await F.ridesPage(n,s||void 0,c,g||void 0);if(l!=null&&l.__notModified)return{notModified:!0,etag:L().etag||null};const f=L();return{page:l,notModified:!1,etag:f.etag||null}}function U(){const{token:n,profile:s}=T(),{lastUpdates:c,connected:g,reconnect:l}=$(),[f,y]=i.useState([]),[V,M]=i.useState({}),[j,m]=i.useState(null),[E,k]=i.useState(null),[p,b]=i.useState(!1),[x,A]=i.useState(""),[v,S]=i.useState(null),[R,_]=i.useState(!1);async function w(t=!1){if(!(!n||(s==null?void 0:s.role)==="driver"||p||R&&!t)){b(!0),S(null);try{const r=await P(n,t?null:j,x||void 0,t||!j?t?null:E:null);if(!r.notModified){if(r.page){const h=r.page,z=(h.rides||[]).map(u=>({...u,fare:u.fare??0}));M(u=>{const o=t?{}:{...u};for(const a of z){const d=o[a._id];!d||new Date(a.createdAt).getTime()<new Date(d.createdAt).getTime()?o[a._id]={...d,...a}:o[a._id]={...a,...d}}const I=Object.values(o).sort((a,d)=>new Date(d.createdAt).getTime()-new Date(a.createdAt).getTime());return y(I),o}),h.nextCursor?m(h.nextCursor):_(!0)}}r.etag&&k(r.etag)}catch(C){S(C.error||"load_failed")}b(!1)}}i.useEffect(()=>{n&&(s==null?void 0:s.role)!=="driver"&&w(!0)},[n,s==null?void 0:s.role,x]);const D=f.map(t=>c[t._id]?{...t,status:c[t._id].status}:t);return e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsx("h2",{children:"My Rides"}),(s==null?void 0:s.role)==="driver"&&e.jsx("p",{style:{color:"red"},children:"forbidden"}),!g&&e.jsxs("div",{style:{background:"#ffe8e8",padding:8,border:"1px solid #f99",borderRadius:4,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{style:{color:"#b00",fontSize:12},children:"Realtime disconnected - using polling"}),e.jsx("button",{onClick:l,style:{fontSize:12},children:"Reconnect"})]}),e.jsx("div",{style:{display:"flex",gap:8,alignItems:"center"},children:e.jsxs("label",{style:{fontSize:12},children:["Filter status",e.jsxs("select",{"aria-label":"Filter rides by status",value:x,onChange:t=>{A(t.target.value),m(null),_(!1)},style:{marginLeft:6},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"cancelled",children:"Cancelled"}),e.jsx("option",{value:"searching",children:"Searching"}),e.jsx("option",{value:"offer_pending",children:"Offer Pending"})]})]})}),e.jsx("ul",{role:"list","aria-label":"Rides",style:{listStyle:"none",margin:0,padding:0,display:"grid",gap:6},children:D.map(t=>e.jsxs("li",{"data-testid":"ride-item","aria-label":`Ride ${t._id} status ${t.status}`,style:{background:"#fafafa",padding:8,borderRadius:4,display:"flex",justifyContent:"space-between"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[e.jsxs("div",{style:{display:"flex",gap:6,alignItems:"center"},children:[e.jsx("strong",{role:"status","aria-live":"polite",children:t.status}),t.surgeMultiplier&&t.surgeMultiplier!==1&&e.jsxs("span",{"aria-label":"Surge multiplier",style:{background:"#ffe08a",color:"#8a5600",fontSize:10,padding:"2px 4px",borderRadius:4},children:["Surge x",t.surgeMultiplier]})]}),e.jsx("span",{style:{fontSize:11},children:new Date(t.createdAt).toLocaleString()})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("span",{"aria-label":"Fare",children:O(t.fare)}),e.jsx(N,{"aria-label":`View ride ${t._id}`,to:`/rides/${t._id}`,children:"View"})]})]},t._id))}),!R&&e.jsx("button",{"aria-label":"Load more rides",disabled:p,onClick:()=>w(!1),children:p?"Loading...":"Load More"}),v&&e.jsx("p",{style:{color:"red"},children:v})]})}export{U as default};
