import{r as d,j as a,A as N}from"./index-CQqwMk0w.js";import{M as P,T,a as R,L as C}from"./TileLayer-Bir63tuw.js";import{u as v,a as _}from"./leaflet-CEdCld2y.js";var M;(M=C.Icon.Default.prototype)==null||delete M._getIconUrl;C.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"});const E="rh_recent_places_v1";function B(){try{const l=localStorage.getItem(E);if(!l)return[];const o=JSON.parse(l);if(Array.isArray(o))return o.filter(Boolean)}catch{}return[]}function A(l){try{const c=B().filter(m=>m.label.toLowerCase()!==l.label.toLowerCase()),u=[{...l,source:"recent"},...c].slice(0,10);localStorage.setItem(E,JSON.stringify(u))}catch{}}const z=({onMapClick:l})=>(_({click(o){o&&o.latlng&&l(o.latlng.lat,o.latlng.lng)}}),null);function D({onPickup:l,onDropoff:o,onPanTo:c}){const[u,m]=d.useState(""),[y,k]=d.useState(""),[j,x]=d.useState(!1),[n,r]=d.useState([]),[w,b]=d.useState([]),L=d.useMemo(()=>B(),[]);function i(e,t){const s=e.trim().toLowerCase(),p=L.filter(g=>!s||g.label.toLowerCase().includes(s)).map(g=>({...g,source:"recent"})),h=new Set(p.map(g=>g.label.toLowerCase())),f=[...p];for(const g of t)h.has(g.label.toLowerCase())||f.push(g);return f.slice(0,8)}async function S(e){if(!e.trim())return null;try{const t=`${N}/geocode?q=${encodeURIComponent(e.trim())}&limit=5&country=ng`,s=await fetch(t,{headers:{Accept:"application/json"}});if(!s.ok)throw new Error(`nominatim_http_${s.status}`);const p=await s.json();return Array.isArray(p)?p.slice(0,5).map(f=>({label:String(f.display_name||f.name||e),lat:parseFloat(f.lat),lng:parseFloat(f.lon),source:"geocode"})):[]}catch(t){try{console.warn("Geocoding failed",(t==null?void 0:t.message)||t)}catch{}try{window.alert("Address lookup failed. If you are offline or a browser extension blocked the request, try again or disable the blocker.")}catch{}}return null}d.useEffect(()=>{let e=!0;const t=u.trim();if(!t){r(i("",[]));return}const s=setTimeout(async()=>{const p=await S(t);if(!e)return;const h=i(t,Array.isArray(p)?p:[]);r(h)},250);return()=>{e=!1,clearTimeout(s)}},[u]),d.useEffect(()=>{let e=!0;const t=y.trim();if(!t){b(i("",[]));return}const s=setTimeout(async()=>{const p=await S(t);if(!e)return;const h=i(t,Array.isArray(p)?p:[]);b(h)},250);return()=>{e=!1,clearTimeout(s)}},[y]);async function I(){"geolocation"in navigator&&(x(!0),navigator.geolocation.getCurrentPosition(e=>{const{latitude:t,longitude:s}=e.coords||{};if(typeof t=="number"&&typeof s=="number"){l(t,s);try{c(t,s)}catch{}}x(!1)},()=>{x(!1)},{enableHighAccuracy:!0,maximumAge:1e4,timeout:1e4}))}return a.jsxs("div",{style:{display:"grid",gap:6,marginBottom:8},children:[a.jsxs("div",{style:{display:"flex",gap:6,position:"relative"},children:[a.jsx("input",{"aria-label":"Search pickup",placeholder:"Search pickup (e.g., Ikeja City Mall)",value:u,onChange:e=>m(e.target.value),style:{flex:1,padding:"6px 8px",border:"1px solid #ccc",borderRadius:6}}),a.jsx("button",{onClick:async()=>{const e=await S(u);if(Array.isArray(e)&&e[0]){const t=e[0];l(t.lat,t.lng);try{A(t)}catch{}}},style:{padding:"6px 10px",borderRadius:6},children:"Search"}),a.jsx("button",{onClick:I,disabled:j,title:"Use my current location",style:{padding:"6px 10px",borderRadius:6},children:j?"Loc…":"Use my location"})]}),n.length>0&&a.jsx("div",{role:"listbox","aria-label":"Pickup suggestions",style:{background:"#fff",border:"1px solid #e5e7eb",borderRadius:6,overflow:"hidden"},children:n.map((e,t)=>a.jsxs("button",{onClick:()=>{l(e.lat,e.lng),m(e.label);try{A(e)}catch{}try{c(e.lat,e.lng)}catch{}},style:{display:"flex",width:"100%",textAlign:"left",padding:"6px 8px",borderBottom:"1px solid #f1f5f9",background:"white"},children:[a.jsx("span",{style:{fontSize:12,color:"#111827"},children:e.label}),e.source==="recent"&&a.jsx("span",{style:{marginLeft:"auto",fontSize:10,color:"#6b7280"},children:"Recent"})]},e.label+String(t)))}),a.jsxs("div",{style:{display:"flex",gap:6,position:"relative"},children:[a.jsx("input",{"aria-label":"Search destination",placeholder:"Search destination (e.g., Lekki Phase 1, 12 Admiralty Way)",value:y,onChange:e=>k(e.target.value),style:{flex:1,padding:"6px 8px",border:"1px solid #ccc",borderRadius:6}}),a.jsx("button",{onClick:async()=>{const e=await S(y);if(Array.isArray(e)&&e[0]){const t=e[0];o(t.lat,t.lng);try{A(t)}catch{}}},style:{padding:"6px 10px",borderRadius:6},children:"Search"})]}),w.length>0&&a.jsx("div",{role:"listbox","aria-label":"Destination suggestions",style:{background:"#fff",border:"1px solid #e5e7eb",borderRadius:6,overflow:"hidden"},children:w.map((e,t)=>a.jsxs("button",{onClick:()=>{o(e.lat,e.lng),k(e.label);try{A(e)}catch{}try{c(e.lat,e.lng)}catch{}},style:{display:"flex",width:"100%",textAlign:"left",padding:"6px 8px",borderBottom:"1px solid #f1f5f9",background:"white"},children:[a.jsx("span",{style:{fontSize:12,color:"#111827"},children:e.label}),e.source==="recent"&&a.jsx("span",{style:{marginLeft:"auto",fontSize:10,color:"#6b7280"},children:"Recent"})]},e.label+String(t)))})]})}const O=({pickup:l,dropoff:o,onChange:c})=>{const u=d.useRef("pickup"),[m,y]=d.useState(null);function k(n,r){u.current==="pickup"?(c({pickup:{lat:n,lng:r}}),u.current="dropoff"):(c({dropoff:{lat:n,lng:r}}),u.current="pickup")}const j=({to:n})=>{const r=v();return d.useEffect(()=>{if(n)try{r.flyTo(n,Math.max(r.getZoom(),14))}catch{}},[n]),null},x=({a:n,b:r})=>{const w=v();return d.useEffect(()=>{if(!n||!r)return;const b=i=>typeof(i==null?void 0:i.lat)=="number"&&typeof(i==null?void 0:i.lng)=="number"&&!Number.isNaN(i.lat)&&!Number.isNaN(i.lng);if(!b(n)||!b(r))return;const L=C.latLngBounds([n.lat,n.lng],[r.lat,r.lng]);try{w.fitBounds(L,{padding:[24,24],maxZoom:16})}catch{}},[n==null?void 0:n.lat,n==null?void 0:n.lng,r==null?void 0:r.lat,r==null?void 0:r.lng]),null};return a.jsxs("div",{style:{height:360},children:[a.jsxs("div",{style:{fontSize:12,marginBottom:6},children:["Click map to set ",u.current," point, or use search below. Markers are draggable."]}),a.jsx("div",{children:a.jsx(D,{onPanTo:(n,r)=>y([n,r]),onPickup:(n,r)=>c({pickup:{lat:n,lng:r}}),onDropoff:(n,r)=>c({dropoff:{lat:n,lng:r}})})}),a.jsxs(P,{center:[l.lat||6.5244,l.lng||3.3792],zoom:13,style:{height:280,width:"100%",borderRadius:12,overflow:"hidden"},children:[a.jsx(T,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors"}),a.jsx(j,{to:m}),a.jsx(x,{a:{lat:l.lat,lng:l.lng},b:{lat:o.lat,lng:o.lng}}),a.jsx(R,{position:[l.lat,l.lng],draggable:!0,eventHandlers:{dragend:n=>{const r=n.target.getLatLng();c({pickup:{lat:r.lat,lng:r.lng}})}}}),a.jsx(R,{position:[o.lat,o.lng],draggable:!0,eventHandlers:{dragend:n=>{const r=n.target.getLatLng();c({dropoff:{lat:r.lat,lng:r.lng}})}}}),a.jsx(z,{onMapClick:k})]})]})};export{O as MapPicker};
