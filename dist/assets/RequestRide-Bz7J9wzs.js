const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MapPicker-DSPx7sIn.js","assets/index-CQqwMk0w.js","assets/index-zbX1gslc.css","assets/TileLayer-Bir63tuw.js","assets/leaflet-CEdCld2y.js","assets/leaflet-Dgihpmma.css"])))=>i.map(i=>d[i]);
import{u as re,r as a,d as ne,j as e,L as P,g as H,e as V,c as ie,_ as de}from"./index-CQqwMk0w.js";import{p,a as h}from"./validation-Bd_H_RqW.js";import{u as le}from"./useRideRequest-DyNG5dVe.js";import{S as ce}from"./SosButton-68yfxByK.js";const oe=a.lazy(()=>de(()=>import("./MapPicker-DSPx7sIn.js"),__vite__mapDeps([0,1,2,3,4,5])).then(s=>({default:s.MapPicker})));function ue(s){return s?s.includes("match")?"Matching…":s.includes("driver_en_route")||s.includes("assigned")||s.includes("matched")?"Driver arriving…":s.includes("pickup_arrived")?"Driver has arrived":s.includes("in_progress")||s.includes("on_trip")?"On trip":s.includes("completed")?"Completed":s.includes("cancel")?"Cancelled":s.replaceAll("_"," "):""}function ge(){const{token:s,profile:v}=re(),[l,A]=a.useState("6.5244"),[c,D]=a.useState("3.3792"),[o,E]=a.useState("6.4500"),[u,T]=a.useState("3.4000"),[b,J]=a.useState("standard"),[i,K]=a.useState("cash"),[U,y]=a.useState(null),[q,O]=a.useState([]),[me,m]=a.useState(null),[j,g]=a.useState(!1),[Q,N]=a.useState(null),[$,W]=a.useState(!1);ne();const d=le(),[f,_]=a.useState(null),[B,F]=a.useState(!1),k=Array.isArray(v==null?void 0:v.paymentMethods)?v.paymentMethods.includes("card"):!1;function X(t,r,n,M){const x=ae=>ae*Math.PI/180,L=x(n-t),se=x(M-r),I=Math.sin(L/2)**2+Math.cos(x(t))*Math.cos(x(n))*Math.sin(se/2)**2;return 6371*(2*Math.atan2(Math.sqrt(I),Math.sqrt(1-I)))}async function Y(t){if(t.preventDefault(),!s){m("not_authenticated");return}g(!0),m(null),y(null),N(null);const r=performance.now();try{if(!["cash","card"].includes(i)){m("invalid_payment_method"),g(!1);return}await d.submit({pickupLat:l,pickupLng:c,dropLat:o,dropLng:u,productType:b,paymentMethod:i})==="immediate"&&d.ride&&y(d.ride),s&&!H()&&V(s).on("ride_status",x=>{O(L=>[x,...L].slice(0,50))})}catch(n){m(n.error||"request_failed")}finally{g(!1),N(Math.round(performance.now()-r))}}async function Z(){if(!s){m("not_authenticated");return}g(!0),m(null),y(null),N(null);const t=performance.now();try{if(!["cash","card"].includes(i)){m("invalid_payment_method"),g(!1);return}await d.submit({pickupLat:l,pickupLng:c,dropLat:o,dropLng:u,productType:b,paymentMethod:i})==="immediate"&&d.ride&&y(d.ride),s&&!H()&&V(s).on("ride_status",C=>{O(x=>[C,...x].slice(0,50))})}catch(r){m(r.error||"request_failed")}finally{g(!1),N(Math.round(performance.now()-t))}}const ee=a.useMemo(()=>{var t;return(t=q[0])==null?void 0:t.status},[q]),z=!!(U||q.length>0),w=p(l)!==null&&h(c)!==null,S=p(o)!==null&&h(u)!==null,te=w&&S&&!!s&&!j,G=i!=="card"||k,R=te&&G;return a.useEffect(()=>{let t=!1;async function r(){if(!w||!S){_(null);return}try{F(!0);const n=await ie.getQuote({pickup:{lat:p(l),lng:h(c)},dropoff:{lat:p(o),lng:h(u)},productType:b});t||_({fare:n.fare||n.total||n.amount,currency:n.currency||"NGN",eta:n.eta})}catch{t||_(null)}finally{t||F(!1)}}return r(),()=>{t=!0}},[l,c,o,u,b]),e.jsxs("div",{className:"max-w-3xl mx-auto p-4",children:[z&&e.jsxs("div",{role:"status","aria-live":"polite",className:"mb-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"inline-flex w-2.5 h-2.5 rounded-full bg-amber-500 animate-pulse","aria-hidden":"true"}),e.jsx("p",{className:"text-sm font-medium",children:j?"Requesting…":ue(ee)||"Preparing request…"})]}),Q!==null&&!j&&e.jsxs("span",{className:"text-[11px] text-slate-500",children:[Q,"ms"]})]}),e.jsxs("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-slate-200 dark:border-slate-700",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Book a ride"})}),e.jsxs("div",{className:"p-4 grid gap-4",children:[e.jsx(a.Suspense,{fallback:e.jsx("div",{className:"h-64 flex items-center justify-center text-sm",children:"Loading map…"}),children:e.jsx(oe,{pickup:{lat:p(l)||0,lng:h(c)||0},dropoff:{lat:p(o)||0,lng:h(u)||0},onChange:t=>{t.pickup&&(A(String(t.pickup.lat)),D(String(t.pickup.lng))),t.dropoff&&(E(String(t.dropoff.lat)),T(String(t.dropoff.lng)))}})}),w&&S&&e.jsxs("div",{className:"rounded-xl border border-slate-200 dark:border-slate-700 p-3 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-semibold",children:"Trip summary"}),e.jsxs("div",{className:"text-xs text-slate-500",children:[B?"Calculating price…":f?`ETA ${f.eta??"—"} min (current conditions)`:"ETA —"," ","• ",(()=>{const t=X(p(l),h(c),p(o),h(u));return isFinite(t)?`${t.toFixed(1)} km`:"—"})()]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-base font-bold",children:B?"—":f!=null&&f.fare?`${f.currency||"NGN"} ${Math.round(f.fare)}`:"—"}),e.jsx("div",{className:"text-[11px] text-slate-500",children:b==="premium"?"Premium":"Standard"})]})]}),i==="card"&&!k&&e.jsxs("div",{className:"rounded-md border border-amber-300 bg-amber-50 text-amber-900 text-xs p-3 flex items-center justify-between gap-3",children:[e.jsx("p",{className:"m-0",children:"To pay by card, add a card in Profile first. Or switch to Cash to request now."}),e.jsx(P,{to:"/profile",className:"inline-flex items-center h-8 px-3 rounded-lg bg-amber-600 hover:bg-amber-700 text-white font-medium whitespace-nowrap",children:"Add a card"})]}),e.jsxs("form",{onSubmit:Y,className:"grid gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs text-slate-500",children:"Tap on the map to set pickup and destination."}),e.jsx("button",{type:"button",onClick:()=>W(t=>!t),className:"text-xs underline",children:$?"Hide advanced":"Edit coordinates"})]}),$&&e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:"text-xs font-medium",children:["Pickup",e.jsx("input",{className:"mt-1 w-full rounded-md border px-3 py-2 text-sm dark:bg-slate-900",value:l+","+c,onChange:t=>{const r=t.target.value.split(",");r.length===2&&(A(r[0].trim()),D(r[1].trim()))},"aria-label":"Pickup coordinates"})]}),e.jsxs("label",{className:"text-xs font-medium",children:["Destination",e.jsx("input",{className:"mt-1 w-full rounded-md border px-3 py-2 text-sm dark:bg-slate-900",value:o+","+u,onChange:t=>{const r=t.target.value.split(",");r.length===2&&(E(r[0].trim()),T(r[1].trim()))},"aria-label":"Destination coordinates"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:"text-xs font-medium",children:["Product",e.jsxs("select",{className:"mt-1 w-full rounded-md border px-3 py-2 text-sm dark:bg-slate-900",value:b,onChange:t=>J(t.target.value),children:[e.jsx("option",{value:"standard",children:"Standard"}),e.jsx("option",{value:"premium",children:"Premium"})]})]}),e.jsxs("label",{className:"text-xs font-medium",children:["Payment",e.jsxs("select",{className:"mt-1 w-full rounded-md border px-3 py-2 text-sm dark:bg-slate-900",value:i,onChange:t=>K(t.target.value),children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"card",children:"Card"})]}),i==="card"&&!k&&e.jsx("span",{className:"mt-2 inline-flex items-center text-xs",children:e.jsx(P,{to:"/profile",className:"ml-auto inline-flex items-center px-2.5 py-1.5 rounded-md bg-brand text-white hover:bg-brand-dark font-medium",children:"Add a card"})})]})]}),e.jsx("button",{disabled:!R,title:s?"":"Login required",className:"mt-2 h-12 rounded-xl bg-brand hover:bg-brand-dark text-white font-semibold text-base disabled:opacity-50",children:j?"Requesting…":i==="card"?"Request Ride (Card)":"Request Ride"}),d.queued&&!d.error&&e.jsx("p",{className:"text-xs text-slate-600",children:"Ride request queued (offline / rate-limited). Sends automatically when back online."}),d.error&&e.jsx("p",{className:"text-sm text-red-600",children:d.error==="payment_method_required"?e.jsxs(e.Fragment,{children:["Card setup required. Please ",e.jsx(P,{to:"/profile",className:"underline text-brand",children:"add a card"})," or switch to Cash."]}):d.error})]})]})]}),e.jsx("div",{className:"fixed left-0 right-0 bottom-0 z-20",children:e.jsx("div",{className:"mx-auto max-w-3xl px-4 pb-4",children:e.jsxs("div",{className:"rounded-2xl shadow-lg bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-semibold",children:"Ready to go?"}),e.jsxs("div",{className:"text-slate-500 text-xs",children:[w?"Pickup set":"Pick a pickup"," • ",S?"Destination set":"Pick a destination"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[i==="card"&&!k&&e.jsx(P,{to:"/profile",className:"inline-flex items-center h-10 px-3 rounded-lg bg-amber-600 hover:bg-amber-700 text-white font-medium whitespace-nowrap",children:"Add a card"}),e.jsx("button",{onClick:Z,disabled:!R,title:s?G?"":"Add a card in Profile or switch to Cash":"Login required",className:`h-12 px-5 rounded-xl font-semibold text-white ${R?"bg-brand hover:bg-brand-dark":"bg-slate-400"} `,children:j?"Requesting…":i==="card"?"Request (Pay by card)":"Request Ride"})]})]})})}),e.jsx("div",{className:"h-20"}),z&&e.jsx(ce,{onClick:()=>alert("Emergency services have been notified. Stay safe.")})]})}export{ge as default};
