import{r as d,j as e,u as C,k as L,c as A,l as K,i as H,m as E,h as J,n as W,t as Y}from"./index-CQqwMk0w.js";import{f as M}from"./format-CHNCD0FC.js";import{M as G,T as V,a as _,L as U}from"./TileLayer-Bir63tuw.js";import{u as X}from"./leaflet-CEdCld2y.js";import{S as Q}from"./SosButton-68yfxByK.js";var $,D;(D=($=U.Icon.Default).mergeOptions)==null||D.call($,{iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"});function P(s){if(!s)return null;if(Array.isArray(s.coordinates)&&s.coordinates.length>=2){const[l,t]=s.coordinates;if(Number.isFinite(t)&&Number.isFinite(l))return{lat:t,lng:l}}return Number.isFinite(s.lat)&&Number.isFinite(s.lng)?{lat:Number(s.lat),lng:Number(s.lng)}:null}function Z(s){return s<.5?2*s*s:-1+(4-2*s)*s}const ee=`
.driver-pulse { width: 12px; height: 12px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 0 0 rgba(34,197,94, 0.7); animation: pulse 1.6s infinite; border:2px solid #052e16; }
@keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34,197,94, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(34,197,94, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34,197,94, 0); } }`;if(typeof document<"u"&&!document.getElementById("driver-pulse-style")){const s=document.createElement("style");s.id="driver-pulse-style",s.innerHTML=ee,document.head.appendChild(s)}const se=U.divIcon({className:"driver-pulse",html:"",iconSize:[12,12]}),te=({target:s})=>{const l=X(),[t,n]=d.useState(s?{lat:s.lat,lng:s.lng,heading:s.heading}:null),c=d.useRef(void 0),a=d.useRef(s?{lat:s.lat,lng:s.lng,at:s.ts||Date.now()}:null);return d.useEffect(()=>{if(!s)return;const u=a.current||{lat:s.lat,lng:s.lng},h={lat:s.lat,lng:s.lng},o=performance.now(),g=300;function N(y){const x=Math.min(1,(y-o)/g),v=Z(x),k=u.lat+(h.lat-u.lat)*v,w=u.lng+(h.lng-u.lng)*v;n({lat:k,lng:w,heading:s?s.heading:void 0}),x<1&&(c.current=requestAnimationFrame(N))}c.current&&cancelAnimationFrame(c.current),c.current=requestAnimationFrame(N),a.current={lat:s.lat,lng:s.lng,at:s.ts||Date.now()};try{l.getBounds().contains([s.lat,s.lng])||l.panTo([s.lat,s.lng],{animate:!0})}catch{}return()=>{c.current&&cancelAnimationFrame(c.current)}},[s==null?void 0:s.lat,s==null?void 0:s.lng]),t?e.jsx(_,{position:[t.lat,t.lng],icon:se}):null},ae=({ride:s,driver:l,height:t=240})=>{const n=P(s==null?void 0:s.pickup),c=P(s==null?void 0:s.dropoff),a=d.useMemo(()=>l?[l.lat,l.lng]:n?[n.lat,n.lng]:c?[c.lat,c.lng]:[6.5244,3.3792],[l,n,c]);return e.jsx("div",{style:{height:t,width:"100%",borderRadius:12,overflow:"hidden"},"aria-label":"Live ride map",children:e.jsxs(G,{center:a,zoom:13,style:{height:"100%",width:"100%"},children:[e.jsx(V,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors"}),n&&e.jsx(_,{position:[n.lat,n.lng]}),c&&e.jsx(_,{position:[c.lat,c.lng]}),l&&e.jsx(te,{target:l})]})})},T={matching:{label:"Matching",cls:"bg-amber-100 text-amber-700 border-amber-300",pulse:!0},matched:{label:"Matched",cls:"bg-sky-100 text-sky-700 border-sky-300"},assigned:{label:"Assigned",cls:"bg-sky-100 text-sky-700 border-sky-300"},pickup_arrived:{label:"Driver Arrived",cls:"bg-indigo-100 text-indigo-700 border-indigo-300"},in_progress:{label:"In Progress",cls:"bg-blue-100 text-blue-700 border-blue-300"},completed:{label:"Completed",cls:"bg-emerald-100 text-emerald-700 border-emerald-300"},cancelled:{label:"Cancelled",cls:"bg-slate-100 text-slate-600 border-slate-300"}},B=({status:s,className:l="",minimal:t})=>{if(!s||!(s in T))return null;const n=T[s];return e.jsx("span",{className:`inline-flex items-center gap-1 rounded-full border px-2.5 py-1 text-[11px] font-medium leading-none shadow-sm ${n.cls} ${n.pulse?"relative status-pulse":""} ${l}`,"aria-label":`Ride status: ${n.label}`,"data-status":s,children:t?n.label.charAt(0):n.label})},le=({ride:s})=>{if(!s)return null;const l=s.driver;return e.jsx("div",{className:"fixed bottom-2 inset-x-2 rounded-2xl shadow bg-white p-4 border border-slate-200 dark:bg-slate-800 dark:border-slate-700",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:"Active Ride"}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-300 flex items-center gap-2",children:["Status: ",e.jsx(B,{status:s.status})]}),l&&e.jsxs("div",{className:"mt-1 flex items-center gap-2 text-xs text-gray-600 dark:text-gray-300 truncate",children:[l.photoUrl&&e.jsx("img",{src:l.photoUrl,alt:"Driver",className:"w-6 h-6 rounded-full object-cover bg-slate-200",onError:t=>{t.currentTarget.style.display="none"}}),e.jsx("span",{className:"truncate",children:l.name||"Driver"}),e.jsx("span",{className:"opacity-70",children:"•"}),e.jsxs("span",{children:["Plate: ",l.plate||l.licensePlate||"—"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"text-sm font-medium",children:["Fare est: ₦",s.finalFare??s.fare]})})]})})},re=[{key:"createdAt",label:"Requested"},{key:"matchedAt",label:"Matched"},{key:"acceptedAt",label:"Accepted"},{key:"pickupArrivalAt",label:"Driver Arrived"},{key:"tripStartAt",label:"Trip Started"},{key:"completedAt",label:"Completed"}],ne=({ride:s})=>s?e.jsx("div",{className:"border-l pl-4 space-y-4",children:re.map(l=>{const t=s[l.key];if(!t)return null;const n=typeof t=="string"||typeof t=="number"?t:void 0;return e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute -left-2 top-1 w-3 h-3 rounded-full bg-brand"}),e.jsxs("p",{className:"text-sm",children:[e.jsxs("span",{className:"font-medium",children:[l.label,":"]})," ",n?new Date(n).toLocaleTimeString():"—"]})]},l.key)})}):null,O="idemp:";function I(s){const l=O+s;let t=sessionStorage.getItem(l);return t||(t=crypto.randomUUID(),sessionStorage.setItem(l,t),t)}function ie(s){sessionStorage.removeItem(O+s)}const ce=({rideId:s,initialPayment:l,onChange:t})=>{const{token:n}=C(),{push:c}=L(),[a,u]=d.useState(l||null),[h,o]=d.useState(!1),[g,N]=d.useState(""),[y,x]=d.useState(null);async function v(){if(!n)return;o(!0),x(null);const b=I(`payments:init:${s}`);try{const i=await A.paymentInitiate(n,{rideId:s,method:"card"},b);u(i),t==null||t(i),c({message:"Payment initiated",type:"info"})}catch(i){x(i.friendlyMessage||i.error||"init_failed")}o(!1)}async function k(){if(!n||!a)return;o(!0),x(null);const b=I(`payments:capture:${a._id}`);try{const i=g?parseInt(g,10):void 0,m=await A.paymentCapture(n,a._id,i,b);u(m),t==null||t(m),m.status==="captured"&&ie(`payments:capture:${a._id}`),c({message:"Captured",type:"success"})}catch(i){x(i.friendlyMessage||i.error||"capture_failed")}o(!1)}async function w(){if(!n||!a)return;o(!0),x(null);const b=I(`payments:refund:${a._id}`);try{const i=g?parseInt(g,10):void 0,m=await A.paymentRefund(n,a._id,i,b);u(m),t==null||t(m),c({message:"Refunded",type:"info"})}catch(i){x(i.friendlyMessage||i.error||"refund_failed")}o(!1)}return e.jsxs("div",{className:"rounded-2xl border p-4 space-y-3 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Payment"}),y&&e.jsx("p",{className:"text-xs text-red-600",role:"alert",children:y}),!a&&e.jsx("button",{onClick:v,disabled:h,className:"px-3 py-2 text-sm rounded-md bg-brand text-white disabled:opacity-50",children:h?"Starting…":"Initiate Payment"}),a&&e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("p",{children:["Status: ",e.jsx("span",{className:"font-medium",children:a.status})]}),e.jsxs("p",{children:["Amount: ₦",a.amount]}),a.capturedAmount!==void 0&&e.jsxs("p",{children:["Captured: ₦",a.capturedAmount]}),a.refundedAmount!==void 0&&e.jsxs("p",{children:["Refunded: ₦",a.refundedAmount]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",min:1,value:g,onChange:b=>N(b.target.value),placeholder:"Amount (optional)",className:"border rounded px-2 py-1 text-xs w-32 dark:bg-slate-900"}),e.jsx("button",{onClick:k,disabled:h||a.status==="refunded",className:"px-2 py-1 rounded bg-green-600 text-white text-xs disabled:opacity-50",children:"Capture"}),e.jsx("button",{onClick:w,disabled:h||a.status!=="captured",className:"px-2 py-1 rounded bg-yellow-500 text-gray-900 text-xs disabled:opacity-50",children:"Refund"})]})]})]})},p=({className:s="",rounded:l="rounded-md"})=>e.jsx("div",{className:`animate-pulse bg-slate-200 dark:bg-slate-700 ${l} ${s}`,"aria-hidden":"true"}),de=()=>e.jsxs("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(p,{className:"h-3 w-24"}),e.jsx(p,{className:"h-3 w-12"})]}),e.jsx(p,{className:"h-8 w-40"}),e.jsx(p,{className:"h-3 w-32"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 pt-2",children:[e.jsx(p,{className:"h-6"}),e.jsx(p,{className:"h-6"}),e.jsx(p,{className:"h-6"})]})]}),oe=()=>e.jsx("div",{className:"border-l pl-4 space-y-5",children:Array.from({length:5}).map((s,l)=>e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute -left-2 top-1 w-3 h-3 rounded-full bg-slate-300 dark:bg-slate-600"}),e.jsx(p,{className:"h-3 w-32"})]},l))}),ue=()=>e.jsxs("div",{className:"p-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 space-y-3",children:[e.jsx(p,{className:"h-4 w-32"}),e.jsx(p,{className:"h-8 w-full"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{className:"h-8 w-24"}),e.jsx(p,{className:"h-8 w-24"})]})]});function be(){const{token:s}=C(),l=K(),t=l.rideId||l.id,{lastUpdates:n,lastDriverPositions:c}=H(),[a,u]=d.useState(null),[h,o]=d.useState(null),[g,N]=d.useState(!1),[y,x]=d.useState(null),[v,k]=d.useState(!1),[w,b]=d.useState(!1),{push:i}=L();async function m(){if(!(!s||!t)){N(!0),o(null);try{const r=await A.rideDetail(s,t);r&&r.eta&&!r.etaMinutes&&(r.etaMinutes=r.eta),u(r);const f=J();f.etag&&x(f.etag)}catch(r){o(r.friendlyMessage||r.error||"load_failed")}N(!1)}}d.useEffect(()=>{m()},[s,t]);const R=t&&n[t]?n[t]:null,S=(R==null?void 0:R.status)||(a==null?void 0:a.status);async function z(){if(!(!s||!t)){k(!0),o(null),u(r=>r&&{...r,status:"cancelled",cancellation:{reason:"user_cancel",actor:"rider",optimistic:!0}});try{const r=await E(`/rides/${t}/cancel`,{method:"POST",headers:{Authorization:`Bearer ${s}`},body:JSON.stringify({reason:"user_cancel"})});u(f=>f&&{...f,status:r.status,cancellation:r.cancellation}),i({message:`Ride ${t} cancelled`,type:"info"})}catch(r){o(r.friendlyMessage||r.error||"cancel_failed"),i({message:r.friendlyMessage||r.error||"Cancel failed",type:"error"}),await m()}k(!1)}}async function q(r){if(!s||!t)return;o(null),b(!0);let f=!1;for(;;)try{const j=await A.patchRide(s,t,{productType:r},y||void 0);await m(),j&&j.rideId&&i({message:"Ride updated",type:"info"});break}catch(j){const F=W(j);if((F.precondition||F.conflict)&&!f){f=!0,await m();continue}else if(j.code==="immutable_state"){i({message:Y("lifecycle_immutable_state","Ride no longer mutable"),type:"info"}),await m();break}else{o(j.friendlyMessage||j.error||"update_failed"),i({message:j.friendlyMessage||"Update failed",type:"error"});break}}b(!1)}return e.jsxs("div",{className:"max-w-xl mx-auto p-4 space-y-4",children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["Ride ",t]}),g&&e.jsxs("div",{className:"space-y-4","aria-busy":"true","aria-live":"polite",children:[e.jsx(de,{}),e.jsx(oe,{}),e.jsx(ue,{})]}),h&&e.jsx("p",{className:"text-sm text-red-600",role:"alert",children:h}),a&&e.jsxs("div",{className:"rounded-2xl shadow p-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",e.jsx(B,{status:S})]}),y&&e.jsx("p",{className:"text-[10px] text-gray-400 select-all",title:"ETag used for concurrency control",children:y})]}),a&&a.driver&&e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-slate-50 dark:bg-slate-700/40","aria-label":"Driver info",children:[e.jsx("img",{src:a.driver.photoUrl||"",alt:"Driver",className:"w-10 h-10 rounded-full object-cover bg-slate-200",onError:r=>{r.currentTarget.style.display="none"}}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium",children:a.driver.name||"Your driver"}),e.jsxs("p",{className:"text-xs text-slate-500",children:["Plate: ",a.driver.plate||a.driver.licensePlate||"—"]})]})]}),(a==null?void 0:a.etaMinutes)&&e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"ETA:"})," ",a.etaMinutes,"m"]}),e.jsx("div",{className:"mt-2",children:e.jsx(ae,{ride:a,driver:c==null?void 0:c[t||""],height:260})}),a.surgeMultiplier&&e.jsxs("p",{className:"text-xs",children:[e.jsx("span",{className:"font-medium",children:"Surge:"})," x",a.surgeMultiplier]}),Array.isArray(a.fareBreakdown)&&a.fareBreakdown.length>0&&e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-700/40 p-3 rounded-lg","aria-label":"Fare breakdown",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Fare Breakdown"}),e.jsx("ul",{className:"space-y-1 text-xs",children:a.fareBreakdown.map((r,f)=>e.jsxs("li",{className:"flex justify-between",children:[e.jsx("span",{children:r.label||r.type||"Component"}),e.jsx("span",{children:typeof r.amount=="number"?M(r.amount):""})]},f))})]}),e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Fare:"})," ",M(a.fare)]}),a.finalFare&&e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Final Fare:"})," ",M(a.finalFare)]}),e.jsx(ne,{ride:a}),S&&!["completed","cancelled","expired"].includes(S)&&e.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[e.jsx("button",{disabled:v,onClick:z,className:"h-12 px-5 rounded-xl text-base font-bold bg-red-600 hover:bg-red-700 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:v?"Cancelling…":"Cancel Ride"}),e.jsx("label",{className:"text-xs font-medium",children:"Product:"}),e.jsxs("select",{"aria-label":"Change product type",value:a.productType||"standard",disabled:w,onChange:r=>q(r.target.value),className:"border rounded-md px-2 py-1 text-sm dark:bg-slate-900",children:[e.jsx("option",{value:"standard",children:"Standard"}),e.jsx("option",{value:"premium",children:"Premium"}),e.jsx("option",{value:"van",children:"Van"})]}),w&&e.jsx("span",{className:"text-xs text-gray-500",children:"Updating..."})]}),e.jsx("div",{className:"pt-2",children:e.jsx(ce,{rideId:a._id})})]}),e.jsx(le,{ride:a}),S&&!["completed","cancelled","expired"].includes(S)&&e.jsx(Q,{onClick:async()=>{try{if(!s||!t)return;await E(`/rides/${t}/sos`,{method:"POST",headers:{Authorization:`Bearer ${s}`},body:JSON.stringify({})}),i({message:"SOS sent to your driver. Stay safe.",type:"info",ttl:6e3})}catch(r){i({message:(r==null?void 0:r.friendlyMessage)||"Failed to send SOS",type:"error"})}}})]})}export{be as default};
