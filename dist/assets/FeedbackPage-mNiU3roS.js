import{u as A,r as c,j as t,c as x}from"./index-CQqwMk0w.js";import{C as v,I as E,B as p}from"./Card-PAg5MTr5.js";const _=()=>{const{token:l}=A(),[o,i]=c.useState([]),[r,u]=c.useState(""),[g,f]=c.useState(!1),[b,y]=c.useState(!1),[j,m]=c.useState(null);async function N(){if(l){y(!0),m(null);try{const a=(await x.listMyFeedback(l)).items.map(s=>({_id:s._id||s.id,id:s.id||s._id,createdAt:s.createdAt,message:s.message}));i(a)}catch(e){m(e.friendlyMessage||e.error||"Failed to load")}finally{y(!1)}}}c.useEffect(()=>{N()},[l]);async function k(){if(!l||!r.trim())return;f(!0);const e={id:"temp-"+Date.now(),createdAt:new Date().toISOString(),message:r.trim(),optimistic:!0};i(a=>[e,...a]);try{const a=await x.submitFeedback(l,r.trim());i(s=>s.map(d=>d.id===e.id?{_id:a.id||a._id,id:a.id||a._id,createdAt:a.createdAt||e.createdAt,message:r.trim()}:d)),u("")}catch(a){i(s=>s.filter(d=>d.id!==e.id)),m(a.friendlyMessage||a.error||"Submit failed")}finally{f(!1)}}function S(e){i(a=>a.map(s=>s.id===e?{...s,editing:!0}:s))}async function w(e,a){if(!l)return;const s=e.message;i(d=>d.map(n=>n.id===e.id?{...n,message:a,optimistic:!0,editing:!1}:n));try{await x.updateFeedback(l,e.id,a,e.createdAt),i(d=>d.map(n=>n.id===e.id?{...n,optimistic:!1}:n))}catch(d){i(n=>n.map(h=>h.id===e.id?{...h,message:s,optimistic:!1}:h)),m(d.friendlyMessage||d.error||"Update failed")}}async function C(e){if(!l)return;const a=o;i(s=>s.filter(d=>d.id!==e.id));try{await x.deleteFeedback(l,e.id)}catch(s){i(a),m(s.friendlyMessage||"Delete failed")}}return t.jsxs("div",{className:"mx-auto max-w-2xl p-4 md:p-6 space-y-6",children:[t.jsxs(v,{title:"Submit Feedback",children:[t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsx(E,{label:"Message",placeholder:"Share your thoughts",value:r,onChange:e=>u(e.target.value),error:r&&r.trim().length>0&&r.trim().length<4?"Min 4 chars":void 0}),t.jsx("div",{className:"flex justify-end",children:t.jsx(p,{onClick:k,disabled:r.trim().length<4,loading:g,children:"Send"})})]}),j&&t.jsx("p",{className:"mt-3 text-sm text-red-600",children:j})]}),t.jsxs(v,{title:"Your Feedback",className:"bg-white dark:bg-slate-800",children:[b&&t.jsx("p",{className:"text-sm text-slate-500",children:"Loadingâ€¦"}),!b&&!o.length&&t.jsx("p",{className:"text-sm text-slate-500",children:"No feedback yet."}),t.jsx("ul",{className:"flex flex-col gap-3",children:o.map(e=>t.jsxs("li",{className:"border border-slate-200 dark:border-slate-700 rounded-md p-3 relative group",children:[e.optimistic&&t.jsx("span",{className:"absolute top-1 right-1 text-[10px] text-amber-600",children:"pending"}),e.editing?t.jsx(F,{item:e,onSave:w,onCancel:()=>i(a=>a.map(s=>s.id===e.id?{...s,editing:!1}:s))}):t.jsxs("div",{className:"space-y-1",children:[t.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:e.message}),t.jsx("p",{className:"text-[10px] uppercase tracking-wide text-slate-400",children:new Date(e.createdAt).toLocaleString()}),t.jsxs("div",{className:"flex gap-2 opacity-0 group-hover:opacity-100 transition",children:[t.jsx(p,{type:"button",variant:"ghost",className:"text-xs px-2 py-1",onClick:()=>S(e.id),children:"Edit"}),t.jsx(p,{type:"button",variant:"ghost",className:"text-xs px-2 py-1 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30",onClick:()=>C(e),children:"Delete"})]})]})]},e.id))})]})]})},F=({item:l,onSave:o,onCancel:i})=>{const[r,u]=c.useState(l.message);return t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("textarea",{className:"w-full min-h-[80px] rounded-md border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand",value:r,onChange:g=>u(g.target.value)}),t.jsxs("div",{className:"flex gap-2 justify-end",children:[t.jsx(p,{type:"button",variant:"secondary",className:"text-xs",onClick:i,children:"Cancel"}),t.jsx(p,{type:"button",className:"text-xs",disabled:r.trim().length<4,onClick:()=>o(l,r.trim()),children:"Save"})]})]})};export{_ as FeedbackPage};
